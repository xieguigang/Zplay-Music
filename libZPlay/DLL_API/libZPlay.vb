''
''  libzplay - windows ( WIN32 ) multimedia library
''
''  ver: 2.00
''  date: 22. April, 2010.
''
''  Copyright (C) 2003-2010 Zoran Cindori
''
''  Author: Zoran Cindori
''  Web: http://libzplay.sourceforge.net/
''  Email: zcindori@inet.hr
''
''
''  This program is free software; you can redistribute it and/or modify
''  it under the terms of the GNU General Public License as published by
''  the Free Software Foundation; either version 2 of the License, or
''  (at your option) any later version.
''
''  This program is distributed in the hope that it will be useful,
''  but WITHOUT ANY WARRANTY; without even the implied warranty of
''  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
''  GNU General Public License for more details.
''
''  You should have received a copy of the GNU General Public License
''  along with this program; if not, write to the Free Software
''  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
''
''
''
'' Supported by:
''
'' ============================================================================
'' libmad - MPEG audio decoder library
'' Copyright (C) 2000-2004 Underbit Technologies, Inc. <support@underbit.com>
'' http://www.underbit.com/products/mad/
'' GNU General Public License ( GPL.TXT )
'' ============================================================================
'' THE OggVorbis SOURCE CODE IS (C) COPYRIGHT 1994-2002 
'' by the Xiph.Org Foundation http://www.xiph.org/
'' BSD-STYLE SOURCE LICENSE  ( XIPH.TXT )
'' ============================================================================
'' LIBA52
'' free library for decoding ATSC A/52 streams.
'' It is released under the terms of the GPL license.
'' ============================================================================
'' FLAC - Free Lossless Audio Codec
'' Copyright (C) 2001,2002,2003,2004,2005,2006,2007  Josh Coalson
'' http://flac.sourceforge.net/
''
'' This file is part the FLAC project.  FLAC is comprised of several
'' components distributed under difference licenses.  The codec libraries
'' are distributed under Xiph.Org's BSD-like license (see the file
'' XIPH.TXT in this distribution).  All other programs, libraries, and
'' plugins are distributed under the LGPL or GPL (see LGPL.TXT and
'' GPL.TXT).  The documentation is distributed under the Gnu FDL (see
'' FDL.TXT).  Each file in the FLAC distribution contains at the top the
'' terms under which it may be distributed.
''
'' Since this particular file is relevant to all components of FLAC,
'' it may be distributed under the Xiph.Org license, which is the least
'' restrictive of those mentioned above.  See the file XIPH.TXT in this
'' distribution.
'' ============================================================================
'' FAAD2 - Freeware Advanced Audio (AAC) Decoder including SBR decoding
'' Copyright (C) 2003-2005 M. Bakker, Nero AG, http://www.nero.com
''
'' This program is free software; you can redistribute it and/or modify
'' it under the terms of the GNU General Public License as published by
'' the Free Software Foundation; either version 2 of the License, or
'' (at your option) any later version.
''
'' This program is distributed in the hope that it will be useful,
'' but WITHOUT ANY WARRANTY; without even the implied warranty of
'' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'' GNU General Public License for more details.
''
'' You should have received a copy of the GNU General Public License
'' along with this program; if not, write to the Free Software
'' Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
''
'' Any non-GPL usage of this software or parts of this software is strictly
'' forbidden.
''
'' The "appropriate copyright message" mentioned in section 2c of the GPLv2
'' must read: "Code from FAAD2 is copyright (c) Nero AG, www.nero.com"
''
'' Commercial non-GPL licensing of this software is possible.
'' For more info contact Nero AG through Mpeg4AAClicense@nero.com.
''
'' ============================================================================
'' FAAC - Freeware Advanced Audio Coder Copyright (C) 2001 M. Bakker
'' This library is free software; you can redistribute it and/or modify it
'' under the terms of the GNU Lesser General Public License as published by the
'' Free Software Foundation; either version 2.1 of the License, or
'' (at your option) any later version. 
''
'' This library is distributed in the hope that it will be useful,
'' but WITHOUT ANY WARRANTY; without even the implied warranty of
'' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
'' See the GNU Lesser General Public License for more details. 
''
'' You should have received a copy of the GNU Lesser General Public License
'' along with this library; if not, write to the Free Software Foundation,
'' Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
''
'' ============================================================================
'' libmp3lame encoder
'' LAME 3.xx LAME Ain't an MP3 Encoder http://www.mp3dev.org March 2001 
'' 
'' Originally developed by Mike Cheng (www.uq.net.au/~zzmcheng).
'' Now maintained by Mark Taylor (www.mp3dev.org). 
''
'' This code is distributed under the GNU LESSER PUBLIC LICENSE (LGPL, see www.gnu.org)
'' with the following modification: 
'' 
'' If you determine that distribution of LAME requires a patent license,
'' and you obtain a patent license, you may distribute LAME even though redistribution
'' of LAME may also require a patent license. 
''
'' You agree not to enforce any patent claims for any aspect of MPEG audio compression,
'' or any other techniques contained in the LAME source code. 
''
'' Copyrights (c) 1999-1007 by The LAME Project Copyrights (c) 1999,2000,2001
'' by Mark Taylor Copyrights (c) 1999,2000,2001 by Mark Taylor Copyrights
'' (c) 1998 by Michael Cheng Copyrights (c) 1995,1996,1997 by Michael Hipp: mpglib
''
'' ============================================================================
'' SoundTouch library Copyright (c) Olli Parviainen 2002-2009 
'' http://www.surina.net/soundtouch
'' GNU Lesser General Public License vesrion 2.1 (LGPL.TXT )
'' ============================================================================
'' Center Cut DSP Plugin for Winamp 2.x 
'' Copyright (C) 2004  Moitah (moitah@yahoo.com)
'' GNU General Public License ( GPL.TXT )
'' ============================================================================
'' Shibatch Super Equalizer ver 0.03 for winamp
'' written by Naoki Shibata  shibatch@users.sourceforge.net
'' http://shibatch.sourceforge.net/
''
'' Shibatch Super Equalizer (except FFT part) is distributed under LGPL.
'' See LGPL.txt for details.
'' FFT part is a routine made by Mr.Ooura. This routine is a freeware.
'' Contact Mr.Ooura for details of distributing licenses.
'' http://momonga.t.u-tokyo.ac.jp/~ooura/fft.html
'' ============================================================================
'' The Independent JPEG Group's JPEG software
'' JPEG decoding library
'' Copyright (C) 1991-2010, Thomas G. Lane, Guido Vollbeding.
'' www.ijg.org
'' ============================================================================
'' ZLIB DATA COMPRESSION LIBRARY
'' (C) 1995-2010 Jean-loup Gailly and Mark Adler
'' http://zlib.net/ 
'' ============================================================================
'' libpng library
'' PNG picture decoding library
'' Copyright (c) 2004, 2006-2007 Glenn Randers-Pehrson
'' http://www.libpng.org/
'' ============================================================================
''

Imports System
Imports System.Runtime.InteropServices
Imports System.Drawing
Imports libZPlay.InternalTypes

''' <summary>
''' 只支持x86平台
''' </summary>
Public Class ZPlay

#Region "Members"

#End Region

#Region "Helper functions"

    Private objptr As UInteger

#End Region

#Region "Constructor and destructor"

    ''' <summary>
    ''' 只支持x86，请在编译的时候选择x86，否则会无法初始化
    ''' </summary>
    Public Sub New()
        objptr = zplay_CreateZPlay()
        If objptr = 0 Then
            Throw New Exception("Can't create libZPlay interface.")
        End If

        If GetVersion() < 190 Then
            Throw New Exception("Need libZPlay.dll version 1.90 and above.")
        End If
    End Sub

    Protected Overrides Sub Finalize()
        zplay_DestroyZPlay(objptr)
    End Sub
#End Region

#Region "Version"
    Public Function GetVersion() As Integer
        Return zplay_GetVersion(objptr)
    End Function

#End Region

#Region "Error handling"
    Public Function GetError() As String
        Return System.Runtime.InteropServices.Marshal.PtrToStringUni(zplay_GetErrorW(objptr))
    End Function


#End Region

#Region "Open and close stream"

    Public Function GetFileFormat(FileName As String) As TStreamFormat
        Return CType(zplay_GetFileFormatW(objptr, FileName), TStreamFormat)
    End Function

    ''' <summary>
    ''' 代开文件，准备开始进行播放
    ''' </summary>
    ''' <param name="FileName"></param>
    ''' <param name="Format"></param>
    ''' <returns></returns>
    Public Function OpenFile(FileName As String, Optional Format As TStreamFormat = TStreamFormat.sfAutodetect) As Boolean
        Return zplay_OpenFileW(objptr, FileName, CInt(Format)) = 1
    End Function

    Public Function SetWaveOutFile(FileName As String, Format As TStreamFormat, ByRef fOutputToSoundcard As Boolean) As Boolean
        Dim s As Integer = 0
        If fOutputToSoundcard Then
            s = 1
        End If
        Return zplay_SetWaveOutFileW(objptr, FileName, CInt(Format), s) = 1
    End Function


    Public Function AddFile(FileName As String, Format As TStreamFormat) As Boolean
        Return zplay_AddFileW(objptr, FileName, CInt(Format)) = 1
    End Function


    Public Function OpenStream(Buffered As Boolean, Dynamic As Boolean, ByRef MemStream() As Byte, StreamSize As UInteger, nFormat As TStreamFormat) As Boolean
        Dim b As Integer = 0
        Dim m As Integer = 0
        If Buffered Then
            b = 1
        End If
        If Dynamic Then
            m = 1
        End If
        Return zplay_OpenStream(objptr, b, m, MemStream, StreamSize, CInt(nFormat)) = 1
    End Function


    Public Function PushDataToStream(ByRef MemNewData() As Byte, NewDatSize As UInteger) As Boolean
        Return zplay_PushDataToStream(objptr, MemNewData, NewDatSize) = 1
    End Function

    Public Function IsStreamDataFree(ByRef MemNewData() As Byte) As Boolean
        Return zplay_IsStreamDataFree(objptr, MemNewData) = 1
    End Function

    Public Function Close() As Boolean
        Return zplay_Close(objptr) = 1
    End Function

#End Region

#Region "Position and Seek"



    Public Sub GetPosition(ByRef time As TStreamTime)
        zplay_GetPosition(objptr, time)
    End Sub


    Public Function Seek(TimeFormat As TTimeFormat, ByRef Position As TStreamTime, MoveMethod As TSeekMethod) As Boolean
        Return zplay_Seek(objptr, TimeFormat, Position, MoveMethod) = 1
    End Function



#End Region

#Region "Play, Pause, Loop, Reverse"



    Public Function ReverseMode(Enable As Boolean) As Boolean
        If Enable Then
            Return zplay_ReverseMode(objptr, 1) = 1
        Else
            Return zplay_ReverseMode(objptr, 0) = 1
        End If

    End Function

    Public Function PlayLoop(TimeFormatStart As TTimeFormat, ByRef StartPosition As TStreamTime, TimeFormatEnd As TTimeFormat, ByRef EndPosition As TStreamTime, NumberOfCycles As UInteger, ContinuePlaying As Boolean) As Boolean
        Dim continueplay As UInteger
        If (ContinuePlaying) Then
            continueplay = 1
        Else
            continueplay = 0
        End If

        Return zplay_PlayLoop(objptr, CInt(Fix(TimeFormatStart)), StartPosition, CInt(Fix(TimeFormatEnd)), EndPosition, NumberOfCycles, continueplay) = 1
    End Function

    Public Function StartPlayback() As Boolean
        Return zplay_Play(objptr) = 1
    End Function

    Public Function StopPlayback() As Boolean
        Return zplay_Stop(objptr) = 1
    End Function

    Public Function PausePlayback() As Boolean
        Return zplay_Pause(objptr) = 1
    End Function

    Public Function ResumePlayback() As Boolean
        Return zplay_Resume(objptr) = 1
    End Function



#End Region

#Region "Equalizer"



    Public Function SetEqualizerParam(PreAmpGain As Integer, ByRef BandGain() As Integer, NumberOfBands As Integer) As Boolean
        Return zplay_SetEqualizerParam(objptr, PreAmpGain, BandGain, NumberOfBands) = 1
    End Function



    Public Function GetEqualizerParam(ByRef PreAmpGain As Integer, ByRef BandGain() As Integer) As Integer
        Dim tempnPreAmpGain1 As Integer = 0
        Dim size As Integer = zplay_GetEqualizerParam(objptr, tempnPreAmpGain1, Nothing, 0)
        Array.Resize(BandGain, size)
        Return zplay_GetEqualizerParam(objptr, PreAmpGain, BandGain, size)
    End Function


    Public Function EnableEqualizer(Enable As Boolean) As Boolean
        If Enable Then
            Return zplay_EnableEqualizer(objptr, 1) = 1
        End If
        Return zplay_EnableEqualizer(objptr, 0) = 1
    End Function

    Public Function SetEqualizerPreampGain(Gain As Integer) As Boolean
        Return zplay_SetEqualizerPreampGain(objptr, Gain) = 1
    End Function

    Public Function GetEqualizerPreampGain() As Integer
        Return zplay_GetEqualizerPreampGain(objptr)
    End Function

    Public Function SetEqualizerBandGain(BandIndex As Integer, Gain As Integer) As Boolean
        Return zplay_SetEqualizerBandGain(objptr, BandIndex, Gain) = 1
    End Function

    Public Function GetEqualizerBandGain(BandIndex As Integer) As Integer
        Return zplay_GetEqualizerBandGain(objptr, BandIndex)
    End Function

    Public Function SetEqualizerPoints(ByRef FreqPointArray() As Integer, NumberOfPoints As Integer) As Boolean
        Return zplay_SetEqualizerPoints(objptr, FreqPointArray, NumberOfPoints) = 1
    End Function

    Public Function GetEqualizerPoints(ByRef FreqPointArray() As Integer) As Integer
        Dim size As Integer = zplay_GetEqualizerPoints(objptr, Nothing, 0)
        Array.Resize(FreqPointArray, size)
        Return zplay_GetEqualizerPoints(objptr, FreqPointArray, size)
    End Function
#End Region

#Region "Echo"


    Public Function EnableEcho(Enable As Boolean) As Boolean
        If Enable Then
            Return zplay_EnableEcho(objptr, 1) = 1
        End If
        Return zplay_EnableEcho(objptr, 0) = 1
    End Function


    Public Function SetEchoParam(ByRef EchoEffectArray() As TEchoEffect, NumberOfEffects As Integer) As Boolean
        Return zplay_SetEchoParam(objptr, EchoEffectArray, NumberOfEffects) = 1
    End Function

    Public Function GetEchoParam(ByRef EchoEffectArray() As TEchoEffect) As Integer
        Dim size As Integer = zplay_GetEchoParam(objptr, Nothing, 0)
        Array.Resize(EchoEffectArray, size)
        Return zplay_GetEchoParam(objptr, EchoEffectArray, size)
    End Function
#End Region

#Region "Volume and Fade"
    Public Function SetMasterVolume(LeftVolume As Integer, RightVolume As Integer) As Boolean
        Return zplay_SetMasterVolume(objptr, LeftVolume, RightVolume) = 1
    End Function

    Public Function SetPlayerVolume(LeftVolume As Integer, RightVolume As Integer) As Boolean
        Return zplay_SetPlayerVolume(objptr, LeftVolume, RightVolume) = 1
    End Function


    Public Sub GetMasterVolume(ByRef LeftVolume As Integer, ByRef RightVolume As Integer)
        zplay_GetMasterVolume(objptr, LeftVolume, RightVolume)
    End Sub

    Public Sub GetPlayerVolume(ByRef LeftVolume As Integer, ByRef RightVolume As Integer)
        zplay_GetPlayerVolume(objptr, LeftVolume, RightVolume)
    End Sub


    Public Function SlideVolume(TimeFormatStart As TTimeFormat, ByRef TimeStart As TStreamTime, StartVolumeLeft As Integer, StartVolumeRight As Integer, TimeFormatEnd As TTimeFormat, ByRef TimeEnd As TStreamTime, EndVolumeLeft As Integer, EndVolumeRight As Integer) As Boolean
        Return zplay_SlideVolume(objptr, TimeFormatStart, TimeStart, StartVolumeLeft, StartVolumeRight, TimeFormatEnd, TimeEnd, EndVolumeLeft, EndVolumeRight) = 1
    End Function

#End Region

#Region "Pitch, tempo, rate"
    Public Function SetPitch(Pitch As Integer) As Boolean
        Return zplay_SetPitch(objptr, Pitch) = 1
    End Function

    Public Function GetPitch() As Integer
        Return zplay_GetPitch(objptr)
    End Function

    Public Function SetRate(Rate As Integer) As Boolean
        Return zplay_SetRate(objptr, Rate) = 1
    End Function

    Public Function GetRate() As Integer
        Return zplay_GetRate(objptr)
    End Function

    Public Function SetTempo(Tempo As Integer) As Boolean
        Return zplay_SetTempo(objptr, Tempo) = 1
    End Function

    Public Function GetTempo() As Integer
        Return zplay_GetTempo(objptr)
    End Function
#End Region

#Region "Bitrate"
    Public Function GetBitrate(Average As Boolean) As Integer
        If Average Then
            Return zplay_GetBitrate(objptr, 1)
        Else
            Return zplay_GetBitrate(objptr, 0)
        End If

    End Function

#End Region

#Region "ID3 Info"

    Public Function LoadID3(Id3Version As TID3Version, ByRef Info As TID3Info) As Boolean
        Dim tmp As TID3Info_Internal
        If zplay_LoadID3W(objptr, CInt(Fix(Id3Version)), tmp) = 1 Then
            Info.Album = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Album)
            Info.Artist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Artist)
            Info.Comment = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Comment)
            Info.Genre = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Genre)
            Info.Title = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Title)
            Info.Track = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Track)
            Info.Year = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Year)
            Return True
        Else
            Return False
        End If
    End Function

    Public Function LoadID3Ex(ByRef Info As TID3InfoEx, fDecodePicture As Boolean) As Boolean
        Dim tmp As TID3InfoEx_Internal

        If zplay_LoadID3ExW(objptr, tmp, 0) = 1 Then
            Info.Album = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Album)
            Info.Artist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Artist)
            Info.Comment = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Comment)
            Info.Genre = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Genre)
            Info.Title = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Title)
            Info.Track = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Track)
            Info.Year = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Year)

            Info.AlbumArtist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.AlbumArtist)
            Info.Composer = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Composer)
            Info.OriginalArtist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.OriginalArtist)
            Info.Copyright = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Copyright)
            Info.Encoder = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Encoder)
            Info.Publisher = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Publisher)
            Info.BPM = tmp.BPM
            Info.Picture.PicturePresent = False

            If fDecodePicture Then
                Try
                    If tmp.PicturePresent = 1 Then
                        Dim stream_data(CInt(tmp.PictureDataSize)) As Byte
                        System.Runtime.InteropServices.Marshal.Copy(tmp.PictureData, stream_data, 0, tmp.PictureDataSize)
                        Info.Picture.BitStream = New System.IO.MemoryStream
                        Info.Picture.BitStream.Write(stream_data, 0, tmp.PictureDataSize)
                        Info.Picture.Bitmap = New Bitmap(Info.Picture.BitStream)
                        Info.Picture.PictureType = tmp.PictureType
                        Info.Picture.Description = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Description)
                        Info.Picture.PicturePresent = True
                    Else
                        Info.Picture.Bitmap = New Bitmap(1, 1)
                    End If
                Catch
                    Info.Picture.PicturePresent = False
                End Try
            End If

            Return True
        Else
            Return False
        End If
    End Function


    Public Function LoadFileID3(FileName As String, Format As TStreamFormat, Id3Version As TID3Version, ByRef Info As TID3Info) As Boolean
        Dim tmp As TID3Info_Internal
        If zplay_LoadFileID3W(objptr, FileName, CInt(Format), CInt(Fix(Id3Version)), tmp) = 1 Then
            Info.Album = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Album)
            Info.Artist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Artist)
            Info.Comment = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Comment)
            Info.Genre = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Genre)
            Info.Title = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Title)
            Info.Track = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Track)
            Info.Year = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Year)
            Return True
        Else
            Return False
        End If

        Return False
    End Function


    Public Function LoadFileID3Ex(FileName As String, Format As TStreamFormat, ByRef Info As TID3InfoEx, fDecodePicture As Boolean) As Boolean
        Dim tmp As TID3InfoEx_Internal

        If zplay_LoadFileID3ExW(objptr, FileName, CInt(Format), tmp, 0) = 1 Then
            Info.Album = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Album)
            Info.Artist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Artist)
            Info.Comment = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Comment)
            Info.Genre = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Genre)
            Info.Title = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Title)
            Info.Track = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Track)
            Info.Year = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Year)

            Info.AlbumArtist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.AlbumArtist)
            Info.Composer = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Composer)
            Info.OriginalArtist = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.OriginalArtist)
            Info.Copyright = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Copyright)
            Info.Encoder = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Encoder)
            Info.Publisher = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Publisher)
            Info.BPM = tmp.BPM

            Info.Picture.PicturePresent = False
            If fDecodePicture Then
                Try
                    If tmp.PicturePresent = 1 Then
                        Dim stream_data(CInt(tmp.PictureDataSize)) As Byte
                        System.Runtime.InteropServices.Marshal.Copy(tmp.PictureData, stream_data, 0, tmp.PictureDataSize)
                        Info.Picture.BitStream = New System.IO.MemoryStream
                        Info.Picture.BitStream.Write(stream_data, 0, tmp.PictureDataSize)
                        Info.Picture.Bitmap = New Bitmap(Info.Picture.BitStream)
                        Info.Picture.PictureType = tmp.PictureType
                        Info.Picture.Description = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Description)
                        Info.Picture.PicturePresent = True
                    Else
                        Info.Picture.Bitmap = New Bitmap(1, 1)
                    End If
                    Return True

                Catch
                    Info.Picture.PicturePresent = False
                End Try
            End If
        Else
            Return False
        End If

        Return False
    End Function


#End Region

#Region "Callback"
    Public Function SetCallbackFunc(CallbackFunc As TCallbackFunc, Messages As TCallbackMessage, UserData As Integer) As Boolean
        Return zplay_SetCallbackFunc(objptr, CallbackFunc, Messages, UserData) = 1
    End Function
#End Region

#Region "Beat-Per-Minute"
    Public Function DetectBPM(Method As TBPMDetectionMethod) As Integer
        Return zplay_DetectBPM(objptr, CUInt(Method))
    End Function

    Public Function DetectFileBPM(FileName As String, Format As TStreamFormat, Method As TBPMDetectionMethod) As Integer
        Return zplay_DetectFileBPMW(objptr, FileName, CInt(Format), CUInt(Method))
    End Function
#End Region

#Region "FFT Graph and FFT values"

    Public Function GetFFTData(FFTPoints As Integer, FFTWindow As TFFTWindow, ByRef HarmonicNumber As Integer, ByRef HarmonicFreq() As Integer, ByRef LeftAmplitude() As Integer, ByRef RightAmplitude() As Integer, ByRef LeftPhase() As Integer, ByRef RightPhase() As Integer) As Boolean
        Return zplay_GetFFTData(objptr, FFTPoints, CInt(Fix(FFTWindow)), HarmonicNumber, HarmonicFreq, LeftAmplitude, RightAmplitude, LeftPhase, RightPhase) = 1
    End Function

    Public Function DrawFFTGraphOnHDC(hdc As System.IntPtr, X As Integer, Y As Integer, Width As Integer, Height As Integer) As Boolean
        Return zplay_DrawFFTGraphOnHDC(objptr, hdc, X, Y, Width, Height) = 1
    End Function

    Public Function DrawFFTGraphOnHWND(hwnd As System.IntPtr, X As Integer, Y As Integer, Width As Integer, Height As Integer) As Boolean
        Return zplay_DrawFFTGraphOnHWND(objptr, hwnd, X, Y, Width, Height) = 1
    End Function


    Public Function SetFFTGraphParam(ParamID As TFFTGraphParamID, ParamValue As Integer) As Boolean
        Return zplay_SetFFTGraphParam(objptr, CInt(Fix(ParamID)), ParamValue) = 1
    End Function

    Public Function GetFFTGraphParam(ParamID As TFFTGraphParamID) As Integer
        Return zplay_GetFFTGraphParam(objptr, CInt(Fix(ParamID)))
    End Function

#End Region

#Region "Center and side cut"

    Public Function StereoCut(Enable As Boolean, OutputCenter As Boolean, BassToSides As Boolean) As Boolean
        Dim fOutputCenter As Integer = 0
        Dim fBassToSides As Integer = 0
        Dim fEnable As Integer = 0
        If OutputCenter Then
            fOutputCenter = 1
        End If
        If BassToSides Then
            fBassToSides = 1
        End If
        If Enable Then
            fEnable = 1
        End If
        Return zplay_StereoCut(objptr, fEnable, fOutputCenter, fBassToSides) = 1
    End Function

#End Region

#Region "Channel mixing"

    Public Function MixChannels(Enable As Boolean, LeftPercent As UInteger, RightPercent As UInteger) As Boolean
        If Enable Then
            Return zplay_MixChannels(objptr, 1, LeftPercent, RightPercent) = 1
        Else
            Return zplay_MixChannels(objptr, 0, LeftPercent, RightPercent) = 1
        End If

    End Function
#End Region

#Region "VU Data"

    Public Sub GetVUData(ByRef LeftChannel As Integer, ByRef RightChannel As Integer)
        zplay_GetVUData(objptr, LeftChannel, RightChannel)
    End Sub

#End Region

#Region "Status and Info"

    Public Sub GetStreamInfo(ByRef info As TStreamInfo)
        Dim tmp As TStreamInfo_Internal
        zplay_GetStreamInfoW(objptr, tmp)

        info.Bitrate = tmp.Bitrate
        info.ChannelNumber = tmp.ChannelNumber
        info.SamplingRate = tmp.SamplingRate
        info.VBR = tmp.VBR
        info.Length = tmp.Length
        info.Description = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.Description)

    End Sub


    Public Sub GetStatus(ByRef status As TStreamStatus)
        zplay_GetStatus(objptr, status)
    End Sub


    Public Sub GetDynamicStreamLoad(ByRef StreamLoadInfo As TStreamLoadInfo)
        zplay_GetDynamicStreamLoad(objptr, StreamLoadInfo)
    End Sub
#End Region

#Region "Wave Out and Wave In Info"

    Public Function EnumerateWaveOut() As Integer
        Return zplay_EnumerateWaveOut(objptr)
    End Function

    Public Function GetWaveOutInfo(Index As UInteger, ByRef Info As TWaveOutInfo) As Boolean
        Dim tmp As TWaveOutInfo_Internal
        If zplay_GetWaveOutInfoW(objptr, Index, tmp) = 0 Then
            Return False
        End If
        Info.Channels = tmp.Channels
        Info.DriverVersion = tmp.DriverVersion
        Info.Formats = tmp.Formats
        Info.ManufacturerID = tmp.ManufacturerID
        Info.ProductID = tmp.ProductID
        Info.Support = tmp.Support
        Info.ProductName = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.ProductName)
        Return True
    End Function

    Public Function SetWaveOutDevice(Index As UInteger) As Boolean
        Return zplay_SetWaveOutDevice(objptr, Index) = 1
    End Function


    Public Function EnumerateWaveIn() As Integer
        Return zplay_EnumerateWaveIn(objptr)
    End Function

    Public Function GetWaveInInfo(Index As UInteger, ByRef Info As TWaveInInfo) As Boolean
        Dim tmp As TWaveInInfo_Internal
        If zplay_GetWaveInInfoW(objptr, Index, tmp) = 0 Then
            Return False
        End If
        Info.Channels = tmp.Channels
        Info.DriverVersion = tmp.DriverVersion
        Info.Formats = tmp.Formats
        Info.ManufacturerID = tmp.ManufacturerID
        Info.ProductID = tmp.ProductID
        Info.ProductName = System.Runtime.InteropServices.Marshal.PtrToStringUni(tmp.ProductName)
        Return True
    End Function

    Public Function SetWaveInDevice(Index As UInteger) As Boolean
        Return zplay_SetWaveInDevice(objptr, Index) = 1
    End Function

#End Region


#Region "Settings"

    Public Function SetSettings(SettingID As TSettingID, Value As Integer) As Integer
        Return zplay_SetSettings(objptr, SettingID, Value)
    End Function


    Public Function GetSettings(SettingID As TSettingID) As Integer
        Return zplay_GetSettings(objptr, SettingID)
    End Function
#End Region

End Class